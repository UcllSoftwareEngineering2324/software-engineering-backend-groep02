name: CI Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: "adopt"
          java-version: "17"

      - name: Setup Flyway Acceptance
        run: |
          echo "
          # POSTGRESQL
          spring.datasource.url=jdbc:postgresql://groep02-database.postgres.database.azure.com:5432/acceptance
          spring.datasource.driver-class-name=org.postgresql.Driver
          spring.datasource.username=gertje
          spring.datasource.password=${{secrets.AZURE_DB_PASSWORD}}

          spring.jpa.hibernate.ddl-auto=validate
          spring.jpa.show-sql=true
          spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
          spring.jpa.properties.hibernate.format_sql=true 
          spring.jpa.database=POSTGRESQL
          spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect

          # Flyway
          spring.flyway.baseline-on-migrate=true
          spring.flyway.enabled=true
          spring.flyway.user=gertje
          spring.flyway.password=s4msonWorst!etenMetCyanide
          spring.flyway.baseline-description="init"
          spring.flyway.baseline-version=0" > src/main/resources/application.properties

      - name: Delete previous package
        run: |
          curl -L \
          -X DELETE \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/orgs/ucllsoftwareengineering2324/packages/maven/be.ucll.se.groep02-backend
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Build and deploy
        run: |
          mvn install -Dmaven.test.skip=true
          mvn --batch-mode deploy
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download package from GitHub Packages
        run: |
          PACKAGE_URL="https://maven.pkg.github.com/UcllSoftwareEngineering2324/software-engineering-backend-groep02/be/ucll/se/groep02-backend/0.0.1/groep02-backend-0.0.1.jar"
          wget --header="Authorization: token ${{ secrets.GITHUB_TOKEN }}" $PACKAGE_URL -O software-engineering-backend-groep02.jar

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: "groep02-backend-acceptance"
          slot-name: "Production"
          package: "software-engineering-backend-groep02.jar"
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_08F1BE3FF77E48E79D50CE2058D09C1F }}
